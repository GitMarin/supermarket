<!doctype html>
<html lang="en" xmlns:v-bind="http://www.w3.org/1999/xhtml" style="height: 100%">
<head>
    <meta charset="utf-8">
    <title>店铺信息</title>
    <link rel="stylesheet" type="text/css" href="styles/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="styles/index.css">
    <link rel="stylesheet" type="text/css" href="styles/vuescroll.css">
    <style>
        #box ul{
            display: flex;
            flex-wrap: wrap;
        }
        #box li{
            padding: 5px;
            list-style: none;
            margin-right: 15px;
            border: 1px solid #eee;
        }
        #box img{
            width: 150px;
            height: 150px;
        }
        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }
        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 150px;
            height: 150px;
            line-height: 150px;
            text-align: center;
        }
        .avatar {
            width: 150px;
            height: 150px;
            display: block;
            border-radius: 5px;
        }
        .el-upload-list--picture .el-upload-list__item.is-success .el-upload-list__item-name{
            width: 125px;
        }
    </style>

</head>
<body style="height: 100%">
<div id="shop" style="height: 100%">
    <el-container style="width: 100%;background-color: white;height: 100%">
        <el-header style="background-color: #5bb2ff">
            <!--存放头像等信息-->
            <el-row height="70px">
                <el-col :span="18">
                    <label style="font-size: 25px;font-family: 仿宋;margin-top: 10px;font-weight: bold">超市管理</label>
                </el-col>
                <el-col :span="3">
                    <el-badge :value="newMessageNumber" :hidden="this.newMessageNumber=='0'" class="item" style="float: right;margin-top: 10px">
                        <img src="img/message.png" style="width: 40px;height: 40px;" @click="openMessage">
                    </el-badge>
                </el-col>
                <el-col :span="3">
                    <el-popover
                        placement="right-start"
                        width="200"
                        trigger="hover">

                        <label>账号：{{id}}</label><br>
                        <label>名字：{{name}}</label><br>
                        <label>简介：{{remark}}</label><br>
                        <el-button-group>
                            <el-button @click="openDg_modifyShop" size="mini">修改信息</el-button>
                            <el-button @click="logout" type="danger" size="mini">退出登录</el-button>
                        </el-button-group>
                        <img :src="picLink" style="border-radius: 20px;width: 60px;height: 60px;float: right" alt="超市头像" slot="reference">
                    </el-popover>
                </el-col>
            </el-row>
        </el-header>
        <el-container style="height: 100%">
            <el-aside style="width: 15%;height: 100%">
                <el-menu
                        style="height: 100%"
                        :default-active="activeIndex"
                        class="el-menu-vertical-demo"
                        @select="handleSelect"
                        background-color="#606266"
                        text-color="#fff"
                        active-text-color="#5bb2ff">
                    <el-menu-item-group>
                        <el-menu-item index="1">商品管理</el-menu-item>
                        <el-menu-item index="2">订单管理</el-menu-item>
                    </el-menu-item-group>
                </el-menu>
            </el-aside>
            <el-main style="margin: 20px auto 0px;width: 90%;">
                <div v-if="this.activeIndex=='1'">
                    <el-form ref="searchForm" :inline="true" :model="searchForm" label-width="80px" size="mini">
                        <el-tabs v-model="activeName" @tab-click="handleTabClick">
                            <el-tab-pane :label="tabMap.all" name="all"></el-tab-pane>
                            <el-tab-pane :label="tabMap.online" name="online"></el-tab-pane>
                            <el-tab-pane :label="tabMap.offline" name="offline"></el-tab-pane>
                            <el-tab-pane :label="tabMap.soldOut" name="soldOut"></el-tab-pane>
                            <el-tab-pane :label="tabMap.prepared" name="prepared"></el-tab-pane>
                            <el-tab-pane :label="tabMap.disabled" name="disabled"></el-tab-pane>
                        </el-tabs>
                        <el-card  style="margin-top: -16px;height: 80px">
                            <el-form-item label="商品名">
                                <el-input v-model="searchForm.name" size="mini"></el-input>
                            </el-form-item>
                            <el-form-item label="商品类型" prop="typeId">
                                <el-cascader expand-trigger="hover" :options="options"  placeholder="请选择类型" :clearable="true"
                                             :change-on-select="true" :show-all-levels="false" @change="searchHandleChange">
                                </el-cascader>
                            </el-form-item>
                            <el-form-item size="mini">
                                <el-button type="primary" @click="search">查询</el-button>
                            </el-form-item>
                        </el-card>
                    </el-form>
                    <el-card>
                        <el-button plain icon="el-icon-share" size="mini" style="float:right;margin-top: -6px" @click="openAddGoods">新建商品</el-button>
                        <el-table :data="tableData" border height="300" size="mini">
                            <el-table-column prop="name" label="商品名" >
                            </el-table-column>
                            <el-table-column prop="typeName" label="类型" >
                            </el-table-column>
                            <el-table-column prop="brandName" label="品牌" >
                            </el-table-column>
                            <el-table-column prop="marque" label="规格" >
                            </el-table-column>
                            <el-table-column prop="depict" label="描述" >
                                <template slot-scope="scope">
                                    <span style="overflow: hidden;text-overflow:ellipsis;white-space: nowrap;" :title="scope.row.depict">
                                        {{scope.row.depict}}
                                    </span>
                                </template>
                            </el-table-column>
                            <el-table-column prop="createTime" label="创建时间" width="180">
                            </el-table-column>
                            <el-table-column label="状态" width="80">
                                <template slot-scope="scope" >
                                    <el-tag v-if="scope.row.status == 'online'">上架中</el-tag>
                                    <el-tag type="info" v-if="scope.row.status == 'offline'">已下架</el-tag>
                                    <el-tag type="danger" v-if="scope.row.status == 'soldOut'">售罄</el-tag>
                                    <el-tag type="success" v-if="scope.row.status == 'prepared'">准备中</el-tag>
                                    <el-tag type="danger" v-if="scope.row.status == 'disabled'">冻结</el-tag>
                                </template>
                            </el-table-column>
                            <el-table-column label="价格" width="180">
                                <template slot-scope="scope" >
                                    <label>参考价：{{scope.row.price}}元</label>
                                    <label >现价：{{scope.row.currentPrice}}元</label>
                                </template>
                            </el-table-column>
                            <el-table-column prop="number" label="数量" width="80">
                            </el-table-column>
                            <el-table-column prop="dealNumber" label="交易量" width="80">
                            </el-table-column>
                            <el-table-column label="操作" width="200">
                                <template slot-scope="scope">
                                    <el-button-group>
                                        <el-button  @click="openShopGoodsModify(scope.row)" v-if="scope.row.status != 'online'" size="mini">修改</el-button>
                                        <el-button @click="openPic(scope.row.goodsId)" v-if="scope.row.status != 'online'" size="mini">图片</el-button>
                                        <el-button @click="openEnabled(scope.row.goodsId)" v-if="scope.row.status == 'disabled'" size="mini">解冻</el-button>
                                        <el-button  @click="onlineShopGoods(scope.row)" v-if="scope.row.status == 'prepared'" size="mini">上架</el-button>
                                        <el-button  @click="offlineShopGoods(scope.row)" v-if="scope.row.status == 'online'" size="mini">下架</el-button>
                                    </el-button-group>
                                </template>
                            </el-table-column>
                        </el-table>
                        <el-pagination
                                :page-sizes="[6, 12, 24, 48]"
                                :current-page="searchForm.current"
                                :page-size.sync ="searchForm.size"
                                @size-change="handleSizeChange"
                                @current-change="handleCurrentChange"
                                layout="total, sizes, prev, pager, next, jumper"
                                :total="searchForm.total">
                        </el-pagination>
                    </el-card>
                </div>

                <div v-if="this.activeIndex=='2'">
                    <el-tabs v-model="activeDealName" @tab-click="handleDealTabClick">
                        <el-tab-pane :label="tabPane.all" name="all"></el-tab-pane>
                        <el-tab-pane :label="tabPane.waitPay" name="waitPay"></el-tab-pane>
                        <el-tab-pane :label="tabPane.waitSend" name="waitSend"></el-tab-pane>
                        <el-tab-pane :label="tabPane.waitConfirm" name="waitConfirm"></el-tab-pane>
                        <el-tab-pane :label="tabPane.waitComment" name="waitComment"></el-tab-pane>
                        <el-tab-pane :label="tabPane.waitRefund" name="waitRefund"></el-tab-pane>
                        <el-tab-pane :label="tabPane.refund" name="refund"></el-tab-pane>
                        <el-tab-pane :label="tabPane.over" name="over"></el-tab-pane>
                    </el-tabs>
                    <el-table border empty-text=" " height="50px" style="width: 100%">
                        <el-table-column label="宝贝" min-width="40%"></el-table-column>
                        <el-table-column label="单价" min-width="15%"></el-table-column>
                        <el-table-column label="数量" min-width="15%"></el-table-column>
                        <el-table-column label="操作" min-width="30%"></el-table-column>
                    </el-table>
                    <div v-for="t in dealTableData" style="width: 100%">
                        <el-card>
                            <el-row>
                                <el-col :span="5"><span>创建时间:{{t.createTime}}</span></el-col>
                                <el-col :span="8"><span>交易单号:{{t.dealId}}</span></el-col>
                                <el-col :span="3"><span>用户名:{{t.userName}}</span></el-col>
                                <el-col :span="3">状态:
                                    <el-tag type="success" v-if="t.status == 'waitPay'">待付款</el-tag>
                                    <el-tag v-if="t.status == 'waitSend'">待发货</el-tag>
                                    <el-tag v-if="t.status == 'waitConfirm'">待收货</el-tag>
                                    <el-tag type="warning" v-if="t.status == 'waitComment'">待评价</el-tag>
                                    <el-tag type="danger" v-if="t.status == 'waitRefund'">待退款</el-tag>
                                    <el-tag type="info" v-if="t.status == 'refund'">已退款</el-tag>
                                    <el-tag type="info" v-if="t.status == 'over'">完成</el-tag>
                                </el-col>
                                <el-col :span="3">交易总额:￥<span style="font-size: 20px;color: #f40;font-weight: 700">{{t.dealPrice}}</span>元</el-col>
                                <el-col :span="2">
                                    <el-button-group>
                                        <el-button size="small" v-if="t.status == 'waitSend'" type="primary" @click="openSend(t.dealId,t.userId)">发货</el-button>
                                        <el-button size="small" v-if="t.status == 'waitRefund'" type="danger" @click="openRefund(t.dealId,t.userId)">退款</el-button>
                                    </el-button-group>
                                </el-col>
                            </el-row>
                        </el-card>
                        <el-card v-for="v in t.cardData" style="height: 55px">
                            <el-row>
                                <el-col :span="10"><span>{{v.goodsName}}</span></el-col>
                                <el-col :span="4"><span style="color: #f40;font-weight: 700">￥{{v.goodsPrice}}元</span></el-col>
                                <el-col :span="3"><span>{{v.goodsNumber}}</span></el-col>
                                <el-col :span="6">

                                </el-col>
                            </el-row>
                        </el-card><br>
                    </div>

                    <el-pagination
                            :page-sizes="[3, 6, 9, 15]"
                            :current-page="dealCurrent"
                            :page-size="dealSize"
                            :total="dealTotal"
                            @size-change="handleDealSizeChange"
                            @current-change="handleDealCurrentChange"
                            layout="total, sizes, prev, pager, next, jumper">
                    </el-pagination>
                </div>
            </el-main>
        </el-container>
    </el-container>


    <!--新建商品弹窗-->
    <el-dialog id="addDg" :title="addDgTitle" :visible.sync="addDgVisible"  width="550px">
        <el-button type="text" @click="openChooseDg">选择系统已登记商品</el-button><br/>
        <el-button type="text" @click="openRegisterDg">登记新商品</el-button>
    </el-dialog>
    <!--新建商品弹窗结束-->

    <!--选择系统已登记商品 弹窗-->
    <el-dialog title="选择系统已登记商品" :visible.sync="chooseDgVisible" width="840px">
    <!--用table展示所有商品信息-->
        <div>
            <el-cascader expand-trigger="hover" :options="options"  placeholder="请选择类型" :clearable="true"
                         :change-on-select="true" :show-all-levels="false" @change="handleChange">
            </el-cascader>
            <el-input v-model="searchName" placeholder="请输入商品名" style="width: 180px"></el-input>
            <el-button type="primary" @click="getGoodsPage">搜索</el-button>
        </div>
        <el-card>
            <div id="box">
                <ul>
                    <li v-for="v in cardData" style="width: 162px;height: 310px">
                        <img v-bind:src="v.condensePicLink" alt="v.name" @click="goodsClick(v)">
                        <p>{{v.name}}</p>
                        <p>{{v.typeName}}</p>
                        <p>{{v.brandName}} {{v.marque}} </p>
                        <p> ￥{{v.price}}元</p>
                    </li>
                </ul>
            </div>
            <div>
                <br>
                <el-pagination
                        :page-sizes="[8, 12, 24, 48]"
                        :current-page="goodsCurrent"
                        :page-size.sync ="goodsSize"
                        @size-change="goodsHandleSizeChange"
                        @current-change="goodsHandleCurrentChange"
                        layout="total, sizes, prev, pager, next, jumper"
                        :total="goodsTotal">
                </el-pagination>
            </div>
        </el-card>
    <!--        使用类型进行选择，关键字搜索-->
    <!--        选择后，将数据进行操作 之后考虑-->
    <!--        关闭弹窗-->
    </el-dialog>
    <!--选择系统已登记商品 弹窗 结束-->

    <!--新建商品 补充数据-->
    <el-dialog  title="补充商品信息" :visible.sync="replenishDgVisible" width="300px" @close="resetForm('replenishForm');resetFileList()">
        <el-form ref="replenishForm" :inline="true" :model="replenishForm" label-width="80px" size="mini">
            <el-form-item prop="condensePicLink">
                <img v-bind:src="replenishForm.condensePicLink" alt="replenishForm.name" style="width: 240px;height: 240px">
            </el-form-item>
            <el-form-item>
                <el-upload
                        class="upload-demo"
                        action="/import"
                        :on-change="handleShopGoodsChange"
                        :on-remove="handleShopGoodsRemove"
                        :file-list="fileList"
                        list-type="picture">
                    <el-button size="small" type="primary">点击上传</el-button>
                    <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb</div>
                </el-upload>
            </el-form-item>
            <el-form-item label="名字" prop="name">
                <el-input v-model="replenishForm.name" size="mini" :disabled="true"></el-input>
            </el-form-item>
            <el-form-item label="描述" prop="depict">
                <el-input v-model="replenishForm.depict" size="mini"></el-input>
            </el-form-item>
            <el-form-item label="定价" prop="currentPrice">
                <el-input v-model="replenishForm.currentPrice" size="mini"></el-input>
            </el-form-item>
            <el-form-item label="数量" prop="num">
                <template>
                    <el-input-number v-model="replenishForm.num" :min="1" :max="9999" ></el-input-number>
                </template>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="saveShopGoods">新建</el-button>
                <el-button @click="resetForm('replenishForm');resetFileList()">重置</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>
    <!--新建商品 补充数据 结束-->


    <!--登记新商品 弹窗-->
    <el-dialog title="登记新商品信息" :visible.sync="registerDgVisible" width="350px" @close="resetForm('registerGoodsForm')">
    <!--提示登记新商品需要管理员通过-->
    <!--        使用form存放数据，选择类型，填写基本信息-->
    <!--        结束 等待管理员 通过-->
        <el-form ref="registerGoodsForm" :inline="true" :model="registerGoodsForm" label-width="80px" size="mini">
            <el-form-item label="商品类型" prop="typeId">
                <el-cascader expand-trigger="hover" :options="options"  placeholder="请选择类型" :clearable="true"
                             :change-on-select="true" :show-all-levels="false" @change="registerGoodsHandleChange">
                </el-cascader>
            </el-form-item>
            <el-form-item label="照片" prop="condensePicLink">
                <el-upload
                        style="display: inline"
                        :show-file-list="false"
                        list-type="picture-card"
                        :on-success="onGoodsSuccess"
                        :on-error="onError"
                        :before-upload="beforeUpload"
                        action="/import">
                    <img v-if="registerGoodsForm.condensePicLink" :src="registerGoodsForm.condensePicLink" class="avatar">
                    <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
            </el-form-item>
            <el-form-item label="品牌名" prop="brandName">
                <el-input v-model="registerGoodsForm.brandName" size="mini"></el-input>
            </el-form-item>
            <el-form-item label="名字" prop="name">
                <el-input v-model="registerGoodsForm.name" size="mini"></el-input>
            </el-form-item>
            <el-form-item label="型号" prop="marque">
                <el-input v-model="registerGoodsForm.marque" size="mini"></el-input>
            </el-form-item>
            <el-form-item label="参考价" prop="price">
                <el-input v-model="registerGoodsForm.price" size="mini"></el-input>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="saveGoods">登记</el-button>
                <el-button @click="resetForm('registerGoodsForm')">重置</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>
    <!--登记新商品 弹窗 结束-->

    <el-dialog title="修改商品信息" :visible.sync="modifyDgVisible" width="350px" @close="resetForm('modifyForm')">
        <el-form ref="modifyForm" :inline="true" :model="modifyForm" label-width="80px" size="mini">
            <el-form-item label="价格" prop="price">
                <el-input v-model="modifyForm.price" size="mini"></el-input>
            </el-form-item>
            <el-form-item label="描述" prop="depict">
                <el-input v-model="modifyForm.depict" size="mini"></el-input>
            </el-form-item>
            <el-form-item label="数量" prop="number">
                <template>
                    <el-input-number v-model="modifyForm.number" :min="1" :max="9999"></el-input-number>
                </template>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="modifyShopGoods" >修改</el-button>
            </el-form-item>
        </el-form>
    </el-dialog>

    <el-dialog title="商品图片展示" :visible.sync="picDgVisible" width="650px">
        <div>
            <ul style="display: flex;flex-wrap: wrap;">
                <li v-for="v in picData" style="padding: 5px;list-style: none;margin-right: 15px;border: 1px solid #eee;">
                    <img :src="v.url" style="height: 150px;width: 150px" @click="openDeletePic(v.id,v.url)">
                </li>
                <el-upload
                        action="/import"
                        :on-success="onShowSuccess"
                        :on-error="onError"
                        :before-upload="beforeUpload"
                        style="display: inline"
                        list-type="picture-card"
                        :show-file-list="false">
                    <img  v-if="'1'=='2'" :src="picLink" class="avatar">
                    <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
            </ul>

        </div>

    </el-dialog>

    <!--修改超市信息弹窗-->

    <el-dialog id="modifyDg" :title="modifyShopDgTitle" :visible.sync="modifyShopDgVisible"  width="350px" @close="dialogClose('modifyShopDgVisible')">
        <el-form :model="modifyShopForm"  :rules="modifyShopFormRules" ref="modifyShopForm" label-width="60px">
            <el-form-item label="头像" prop="picLink">
                <el-upload
                        style="display: inline"
                        :show-file-list="false"
                        list-type="picture-card"
                        :on-success="onShopSuccess"
                        :on-error="onError"
                        :before-upload="beforeUpload"
                        action="/import">
                    <img v-if="modifyShopForm.picLink" :src="modifyShopForm.picLink" class="avatar">
                    <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                </el-upload>
            </el-form-item>
            <el-form-item label="昵称" prop="name">
                <el-input v-model="modifyShopForm.name" autocomplete="off" clearable></el-input>
            </el-form-item>
            <el-form-item label="介绍" prop="remark">
                <el-input v-model="modifyShopForm.remark" autocomplete="off" clearable></el-input>
            </el-form-item>

            <el-form-item label="地址" prop="address">
                <el-input v-model="modifyShopForm.address" autocomplete="off" clearable></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button type="primary" size="mini" @click="modifyShop">保 存</el-button>
        </div>
    </el-dialog>

        <!-- message展示   -->
    <el-dialog title="信息展示" :visible.sync="messageDgVisible" width="650px" height="650px">
        <div v-for="v in messageData">
            <p>
                <el-tag v-if="v.status=='new'" type="success">新</el-tag>
                {{v.message}}
                <el-button size="mini" type="danger" icon="el-icon-delete" @click="openDeleteMessage(v.id)" style="float: right"></el-button>
            </p><br>

        </div>
    </el-dialog>
</div>
</body>
<script src="js/vue.js"></script>
<script src="js/index.js"></script>
<script src="js/axios.min.js"></script>
<script src="js/vuescroll-native.js"></script>
<script src="js/vuescroll-slide.js"></script>
<script src="js/vuescroll.js"></script>
<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/msg.js"></script>
<script type="text/javascript">
    new Vue({
        el:"#shop",
        data:function(){
            return{
                activeIndex:"1",
                newMessageNumber:0,
                messageDgVisible:false,
                messageData:[],

                dealTableData:[],
                dealCurrent:1,
                dealTotal:0,
                status:null,
                dealSize:3,
                activeDealName:"all",

                tableData:[],
                activeName:"all",
                searchForm: {
                    current:1,
                    size:6,
                    total:null,
                    name:null,
                    status:null,
                    typeId:null,
                },
                tabMap:{
                    all:"全部",
                    online:"上架中",
                    offline:"已下架",
                    soldOut:"售罄",
                    prepared:"准备中",
                    disabled:"冻结",
                },

                tabPane:{
                    all:"全部",
                    waitPay:"待付款",
                    waitSend:"待发货",
                    waitConfirm:"待收货",
                    waitComment:"待评价",
                    waitRefund:"待退款",
                    refund:"已退款",
                    over:"完成",
                },
                shopId:0,
                id:null,
                name:null,
                remark:null,
                picLink:null,

                //新建商品弹窗
                addDgTitle:"新建商品",
                addDgVisible:false,
                addForm:{},
                addFormRules:{},

                //选择goods商品弹窗
                options: [],
                cardData:[],
                typeId:null,
                searchName:null,
                chooseDgVisible:false,
                goodsCurrent:1,
                goodsSize:8,
                goodsTotal:null,
                //补充信息弹窗信息
                replenishDgVisible:false,
                replenishForm: {

                },

                fileList: [],
                //登记新商品弹窗
                registerDgVisible:false,
                registerGoodsForm:{
                    condensePicLink:null,

                },

                //修改商品信息弹窗
                modifyDgVisible:false,
                modifyForm:{
                    number:1
                },

                picDgVisible:false,
                picData:{},
                picGoodsId:null,
                //修改超市信息弹窗
                modifyShopDgTitle:null,
                modifyShopDgVisible:false,
                modifyShopForm:{
                    id:null,
                    nickname: null,
                    gender:null,
                    sign:null,
                    address:null,
                    picLink:null,
                },
                modifyShopFormRules:{
                    name: [
                        { required: true, message: '请输入超市名', trigger: 'blur' },
                        { min: 2,  message: '不可少于2个字符', trigger: 'blur' }
                    ],
                    remark:[
                        { required: true, message: '请输入介绍', trigger: 'blur' },
                        { min: 2,  message: '不可少于2个字符', trigger: 'blur' }
                    ],
                    address:[
                        { required: true, message: '请输入地址', trigger: 'blur' },
                        { min: 2,  message: '不可少于2个字符', trigger: 'blur' }
                    ],
                },
            }

        },
        methods:{
            //左侧栏目功能
            handleSelect(key) {
                this.activeIndex=key;
                if(this.activeIndex=="1")   {
                    this.initTable();
                    this.activeName="all";
                }
                if(this.activeIndex=="2")   {
                    this.initDealTable();
                    this.activeDealName="all";
                }
            },
            logout:function(){
                this.$confirm('退出登录, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    axios.get('http://'+window.location.host+'/logout')
                        .then(function (response) {
                            window.location.href = "";
                        })
                        .catch(function (error) {
                        });
                    this.$message({
                        type: 'success',
                        message: '退出成功!'
                    });
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },
            showShop(){
                const _this=this;
                axios.get('http://'+window.location.host+'/shop/getOneShop',{params:{id:_this.shopId}})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.name=response.data.rtnData.name;
                            _this.id=response.data.rtnData.id;
                            _this.remark=response.data.rtnData.remark;
                            _this.address=response.data.rtnData.address;
                            _this.picLink=response.data.rtnData.picLink;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "获取超市信息"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            getNewMessageNumber:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/getNewMessageNumber',{latterId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.newMessageNumber=response.data.rtnData;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            openMessage:function(){
                this.messageDgVisible=true;
                this.getMessage();
            },
            getMessage:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/getMessage',{latterId:_this.shopId,type:"shop"})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.messageData=response.data.rtnData;
                            _this.getNewMessageNumber();
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            openDeleteMessage:function(id){
                this.$confirm('删除该信息, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.deleteMessage(id);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },
            deleteMessage:function(id){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/deleteMessage',{id:id})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.getMessage();
                            _this.$message({
                                type: 'success',
                                message: '删除成功!'
                            });
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },


            search(){
                this.initTable();
            },
            searchHandleChange(value){
                this.searchForm.typeId=value[value.length-1];
            },
            initTable:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/getShopGoodsPage',{form:_this.searchForm,shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.tableData=response.data.rtnData.dataList;
                            _this.searchForm.total=response.data.total;
                            _this.tabMap.all="全部("+response.data.rtnData.dataStatistics.all+")";
                            _this.tabMap.offline="已下架("+response.data.rtnData.dataStatistics.offline+")";
                            _this.tabMap.online="上架中("+response.data.rtnData.dataStatistics.online+")";
                            _this.tabMap.soldOut="售罄("+response.data.rtnData.dataStatistics.soldOut+")";
                            _this.tabMap.prepared="准备中("+response.data.rtnData.dataStatistics.prepared+")";
                            _this.tabMap.disabled="冻结("+response.data.rtnData.dataStatistics.disabled+")";
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "获取超市商品信息"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            getGoodsPage:function(){
                const _this=this;
                _this.loading=true;
                axios.post('http://'+window.location.host+'/goods/getGoodsPage',{size:_this.goodsSize,
                    current:_this.goodsCurrent,typeId:_this.typeId,name:_this.searchName,status:"enabled",number:0})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.cardData=response.data.rtnData;
                            _this.goodsTotal=response.data.total;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "初始化商品数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            handleChange:function(value){
                this.typeId=value[value.length-1];
            },
            handleTabClick:function(obj){
                if(obj.name=="all"){
                    this.searchForm.status=null;
                    this.initTable();
                }else{
                    this.searchForm.status=obj.name;
                    this.initTable();
                }
                this.searchForm.current=1;
            },

            handleSizeChange:function(val) {
                this.searchForm.size=val;
                this.initTable();
            },
            handleCurrentChange:function(val) {
                this.searchForm.current=val;
                this.initTable();
            },

            //打开新建商品弹窗
            openAddGoods:function () {
                this.addDgVisible=true;
            },
            //关闭新建商品弹窗
            dialogClose:function(formName){
                this.$refs[formName].resetFields();
                this.registerDgVisible=false;
            },

            goodsHandleSizeChange:function(val){
                this.goodsSize=val;
                this.getGoodsPage();
            },
            goodsHandleCurrentChange:function(val){
                this.goodsCurrent=val;
                this.getGoodsPage();
            },
            //打开选择商品弹窗
            goodsClick:function(v){
                this.chooseDgVisible=false;
                this.replenishDgVisible=true;
                this.replenishForm=v;
            },
            openChooseDg:function () {
                this.chooseDgVisible=true;
                this.getGoodsPage();
            },
            saveShopGoods:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/addShopGoods',{form:_this.replenishForm,shopId:_this.shopId,fileList:_this.fileList})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.replenishDgVisible=false;
                            _this.addDgVisible=false;
                            _this.initTable();
                            _this.$message('新建超市商品数据成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$message.error('该商品已存在！');
                            // _this.$bdmsg({
                            //     type:"toast",
                            //     msgType:"error",
                            //     message: "新建超市商品数据"+'失败！'+response.data.rtnMsg
                            // });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            //登记新商品弹窗
            openRegisterDg:function(){
                this.registerDgVisible=true;
            },
            registerGoodsHandleChange:function(value){
                this.registerGoodsForm.typeId=value[value.length-1];
            },
            resetForm:function(formName){
                const _this=this;
                _this.$refs[formName].resetFields();
            },

            addMessage:function(message,relatedId,type,latterId){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/addMessage',{formerId:_this.shopId,latterId:latterId
                    ,relatedId:relatedId,context:message,type:type})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            openEnabled:function(goodsId){
                this.$confirm('确定商品信息正确，要求解冻？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.addMessage("请求解冻该商品！",goodsId,"enabledShopGoods","admin");
                    this.$message({
                        type: 'success',
                        message: '请求成功!'
                    });
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },

            saveGoods:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/goods/addGoods',{form:_this.registerGoodsForm,status:"unaudited"})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.registerGoodsForm.id=response.data.rtnData.id;
                            _this.registerDgVisible=false;
                            _this.addMessage("新建商品数据，请审核！",response.data.rtnData.id,"auditGoods","admin");
                            _this.$message('新建商品数据成功！请等待管理员审核。');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "新建商品数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            //图片展示 修改弹窗

            openPic:function(goodsId){
                this.picData=[];
                this.picDgVisible=true;
                this.picGoodsId=goodsId;
                this.getShopGoodsPic(this.picGoodsId);
            },
            openDeletePic:function(imageId,url){
                this.$confirm('确认删除该图片?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.deletePic(imageId,url);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },
            deletePic:function(imageId,url){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/deleteShopGoodsPic',{imageId:imageId,url:url})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.getShopGoodsPic(_this.picGoodsId);
                            _this.$message({
                                message: '删除成功',
                                type: 'success'
                            });
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            getShopGoodsPic:function(goodsId){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/getShopGoodsPic',{goodsId:goodsId,shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.picData=response.data.rtnData;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            //修改商品信息
            openShopGoodsModify:function(shopGoods){
                this.modifyDgVisible=true;
                this.modifyForm=JSON.parse(JSON.stringify(shopGoods));
            },

            modifyShopGoods:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/modifyShopGoods',{form:_this.modifyForm,shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.modifyDgVisible=false;
                            _this.initTable();
                            _this.$message('修改超市商品数据成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            // _this.$bdmsg({
                            //     type:"toast",
                            //     msgType:"error",
                            //     message: "新建超市商品数据"+'失败！'+response.data.rtnMsg
                            // });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            onlineShopGoods:function(shopGoods){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/onlineShopGoods',{form:shopGoods,shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initTable();
                            _this.$message('上架超市商品成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else if(response.data.rtnFlag=="3001"){
                            _this.$message.error('商品数量错误！');
                        }else if(response.data.rtnFlag=="3004"){
                            _this.$message.error('该商品已被冻结不能上架！');
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            offlineShopGoods:function(shopGoods){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/offlineShopGoods',{form:shopGoods,shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initTable();
                            _this.$message('下架超市商品成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else {
                            _this.$message.error('下架超市商品失败！');
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            handleShopGoodsChange(file, fileList) {

                this.fileList.length=0;
                for (var i = 0; i < fileList.length; i++) {
                    if (fileList[i].response != null) this.fileList[i] = fileList[i].response.rtnData;
                }

            },
            handleShopGoodsRemove(file, fileList) {
                this.fileList.length=0;
                for (var i = 0; i < fileList.length; i++) {
                    if (fileList[i].response != null) this.fileList[i] = fileList[i].response.rtnData;
                }
            },

            resetFileList:function(){
                this.fileList=[];
            },

            getParentGoodsType:function(){
                const _this=this;
                axios.get('http://'+window.location.host+'/goodsType/getParentGoodsType')
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.options=response.data.rtnData;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "获取上级类型数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            initDealTable:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/deal/getDealPage',{size:_this.dealSize,current:_this.dealCurrent,shopId:_this.shopId,status:_this.status})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.dealTableData=response.data.rtnData.resultList;
                            _this.dealTotal=response.data.total;
                            _this.tabPane.all="全部("+response.data.rtnData.dataStatistics.all+")";
                            _this.tabPane.waitPay="待付款("+response.data.rtnData.dataStatistics.waitPay+")";
                            _this.tabPane.waitSend="待发货("+response.data.rtnData.dataStatistics.waitSend+")";
                            _this.tabPane.waitConfirm="待收货("+response.data.rtnData.dataStatistics.waitConfirm+")";
                            _this.tabPane.waitComment="待评价("+response.data.rtnData.dataStatistics.waitComment+")";
                            _this.tabPane.waitRefund="待退款("+response.data.rtnData.dataStatistics.waitRefund+")";
                            _this.tabPane.refund="已退款("+response.data.rtnData.dataStatistics.refund+")";
                            _this.tabPane.over="完成("+response.data.rtnData.dataStatistics.over+")";
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: '初始化交易列表数据'+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            handleDealSizeChange:function(val){
                this.dealSize=val;
                this.initDealTable();
            },
            handleDealCurrentChange:function(){
                this.dealCurrent=val;
                this.initDealTable();
            },

            handleDealTabClick:function(obj){
                if(obj.name=="all"){
                    this.status=null;
                    this.initDealTable();
                }else{
                    this.status=obj.name;
                    this.initDealTable();
                }
                this.dealCurrent=1;
            },

            openDg_modifyShop(){
                this.modifyShopDgTitle='修改超市信息（'+this.shopId+"）"
                this.modifyShopForm.id=this.shopId;
                this.modifyShopForm.name=this.name;
                this.modifyShopForm.address=this.address;
                this.modifyShopForm.remark=this.remark;
                this.modifyShopForm.picLink=this.picLink;
                this.modifyShopDgVisible=true;
            },


            openSend:function(dealId,userId){
                this.$confirm('确认发货?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.send(dealId,userId);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },
            send:function(dealId,userId){
                const _this=this;
                axios.post('http://'+window.location.host+'/deal/changeDealStatus',{dealId:dealId,status:"waitConfirm"})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initDealTable();
                            _this.addMessage("该商品已发货！",dealId,"shopDeliverGoods",userId);
                            _this.$message({
                                message: '发货成功',
                                type: 'success'
                            });
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: '发货'+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            openRefund:function(dealId,userId){
                this.$confirm('确认退款?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.refund(dealId,userId);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },

            refund:function(dealId,userId){
                const _this=this;
                axios.post('http://'+window.location.host+'/deal/shopRefundDeal',{dealId:dealId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initDealTable();
                            _this.addMessage("该商品已退款",dealId,"shopRefund",userId);
                            _this.$message({
                                message: '退款成功',
                                type: 'success'
                            });
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: '退款'+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            onShopSuccess:function(response, file, fileList) {
                this.modifyShopForm.picLink=response.rtnData;
            },
            onGoodsSuccess:function(response, file, fileList) {
                this.registerGoodsForm.condensePicLink=response.rtnData;
            },
            onShowSuccess:function(response, file, fileList){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/addOneImage',
                    {   shopId:_this.shopId,
                        goodsId:_this.picGoodsId,
                        url:response.rtnData,
                    }).then(function (responsed) {
                    if(responsed.data.rtnFlag=="9999"){//请求成功
                        _this.$message('添加图片成功！');
                        _this.getShopGoodsPic(_this.picGoodsId);
                    }else if(responsed.data.rtnFlag=="1001"){//未登录
                        //_this.loginDgVisible=true;
                    }else{}
                }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });

            },
            onError(err, file, fileList) {},
            beforeUpload(file) {},

            dialogClose:function(visible,form){
                //form 重置没做到
                if(form){
                    this.resetForm(form);
                }
                this[visible]=false;
            },
            modifyShop:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/shop/modifyShop',
                    {   id:_this.modifyShopForm.id,
                        name: _this.modifyShopForm.name,
                        address:_this.modifyShopForm.address,
                        remark:_this.modifyShopForm.remark,
                        picLink:_this.modifyShopForm.picLink,
                    }).then(function (response) {
                    if(response.data.rtnFlag=="9999"){//请求成功
                        _this.$message('超市信息修改成功！');
                        _this.modifyShopDgVisible=false;
                        _this.showShop();
                    }else if(response.data.rtnFlag=="1001"){//未登录
                        //_this.loginDgVisible=true;
                    }else{
                        _this.$bdmsg({
                            type:"toast",
                            msgType:"error",
                            message: '账号信息修改失败！'+response.data.rtnMsg
                        });
                    }
                }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
        },
        mounted: function() {
            const _this=this;
            var url = window.location.href;
            _this.shopId =  url.split("?")[1].split("=")[1];
            this.getParentGoodsType();
            this.getNewMessageNumber();
            this.initTable();
            this.showShop();
        },
    });
</script>
</html>

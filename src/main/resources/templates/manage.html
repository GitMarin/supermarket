<!DOCTYPE html>
<html lang="en" style="height: 100%">
<head>
    <meta charset="UTF-8">
    <title>管理员平台</title>
    <link rel="stylesheet" type="text/css" href="styles/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="styles/index.css">
    <link rel="stylesheet" type="text/css" href="styles/vuescroll.css">
    <style>
        .avatar-uploader .el-upload {
            border: 1px dashed #d9d9d9;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .avatar-uploader .el-upload:hover {
            border-color: #409EFF;
        }
        .avatar-uploader-icon {
            font-size: 28px;
            color: #8c939d;
            width: 146px;
            height: 146px;
            line-height: 178px;
            text-align: center;
        }
        .avatar {
            width: 146px;
            height: 146px;
            display: block;
            border-radius: 5px;
        }
    </style>
</head>
<body style="height: 100%">
<div id="manage" style="height: 100%">
    <el-container style="width: 100%;background-color: white;height: 100%">
        <el-header style="background-color: #5bb2ff">
            <el-row>
                <el-col :span="17">
                    <h5 style="text-align: center;color: white;height: 30px;line-height: 50px;float: left;">管理系统</h5>
                </el-col>
                <el-col :span="4">
                    <el-badge :value="newMessageNumber" :hidden="this.newMessageNumber=='0'" class="item" style="float: right;margin-top: 10px">
                        <img src="img/message.png" style="width: 40px;height: 40px;" @click="openMessage">
                    </el-badge>
                </el-col>
                <el-col :span="3">
                    <el-button @click="logout" type="danger" style="float: right;margin-top: 10px">退出登录</el-button>
                </el-col>
            </el-row>
        </el-header>
        <el-container style="height: 100%">
            <el-aside style="width: 15%;height: 100%">
                <el-menu
                        style="height: 100%"
                        :default-active="activeIndex"
                        class="el-menu-vertical-demo"
                        @select="handleSelect"
                        background-color="#606266"
                        text-color="#fff"
                        active-text-color="#5bb2ff">
                    <el-menu-item-group>
                        <el-menu-item index="1">商品类型</el-menu-item>
                        <el-menu-item index="2">商品管理</el-menu-item>
                        <el-menu-item index="3">超市管理</el-menu-item>
                        <el-menu-item index="4">订单管理</el-menu-item>
                    </el-menu-item-group>
                </el-menu>
            </el-aside>
            <el-main style="height: 100%">
                <!---------------商品类型管理--------------->
                <el-row v-if="this.activeIndex=='1'" style="height: 100%">
                    <el-col :span="7">
                        <el-card shadow="always">
                            <div slot="header">
                                <span>{{title}}</span>
                            </div>
                            <el-row>
                                <el-col :span="24">
                                    <el-button type="primary" style="width:100%;" @click="btnCk($event)" v-if="this.formStyle=='display:none;'">创建新类型</el-button>
                                </el-col>
                            </el-row>

                            <el-form ref="form" :model="form" label-width="80px" :style="formStyle" size="small">
                                <el-form-item label="上级类型" prop="pName">
                                    <el-cascader expand-trigger="hover" :options="options"  placeholder="请选择" :clearable="true" v-model="form.pName"
                                                 :change-on-select="true" :show-all-levels="false" @change="handleChange">
                                    </el-cascader>
                                </el-form-item>
                                <el-form-item label="类型名称" prop="name">
                                    <el-input v-model="form.name"></el-input>
                                </el-form-item>
                                <el-form-item label="类型值" prop="value">
                                    <el-input v-model="form.value"></el-input>
                                </el-form-item>
                                <el-form-item label="类型描述" prop="summary">
                                    <el-input v-model="form.summary"></el-input>
                                </el-form-item>
                                <el-row class="mt">
                                    <el-col :span="24" style="text-align: right;">
                                        <el-button type="primary" @click="saveParameter" v-if="this.title=='新建类型'">保存</el-button>
                                        <el-button type="primary" @click="modifyParameter" v-if="this.title=='修改类型'">修改</el-button>
                                        <el-button @click="resetForm('form')">重置</el-button>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </el-card>
                    </el-col>
                    <el-col :span="17">
                        <el-card shadow="always">
                            <div slot="header">
                                <span>商品类型列表</span>
                            </div>
                            <el-row >
                                <el-col :span="24" >
                                    <el-table :data="tableData" border height="450" size="mini">
                                        <el-table-column prop="name" label="类型名称" >
                                        </el-table-column>
                                        <el-table-column prop="parentName" label="上级类型" >
                                        </el-table-column>
                                        <el-table-column prop="value" label="类型值" >
                                        </el-table-column>
                                        <el-table-column prop="level" label="类型等级" >
                                        </el-table-column>
                                        <el-table-column prop="summary" label="类型描述" >
                                        </el-table-column>
                                        <el-table-column fixed="right" label="操作" width="100">
                                            <template slot-scope="scope">
                                                <el-button type="text" size="small" @click="openModify(scope.row)">修改</el-button>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                    <el-pagination
                                            :page-sizes="[8, 16, 32, 64]"
                                            :current-page="current"
                                            :page-size ="size"
                                            @size-change="handleSizeChange"
                                            @current-change="handleCurrentChange"
                                            layout="total, sizes, prev, pager, next, jumper"
                                            :total="total">
                                    </el-pagination>
                                </el-col>
                            </el-row>
                        </el-card>
                    </el-col>
                </el-row>
                <!---------------商品类型管理--------------->
                <el-row v-if="this.activeIndex=='2'">
                    <el-col :span="7">
                        <el-card shadow="always">
                            <div slot="header">
                                <span>{{goodsTitle}}</span>
                            </div>
                            <el-row>
                                <el-col :span="24">
                                    <el-button type="primary" style="width:100%;" @click="goodsBtnCk($event)" v-if="this.goodsFormStyle=='display:none;'">创建新商品</el-button>
                                </el-col>
                            </el-row>

                            <el-form ref="goodsForm" :model="goodsForm" label-width="80px" :style="goodsFormStyle" size="small">
                                <el-form-item label="商品类型" prop="pName">
                                    <el-cascader expand-trigger="hover" :options="options"  placeholder="请选择" :clearable="true" v-model="goodsForm.pName"
                                                 :change-on-select="true" :show-all-levels="false" @change="goodsHandleChange">
                                    </el-cascader>
                                </el-form-item>
                                <el-form-item label="照片" prop="condensePicLink">
                                    <el-upload
                                            style="display: inline"
                                            :show-file-list="false"
                                            list-type="picture-card"
                                            :on-success="onGoodsSuccess"
                                            :on-error="onError"
                                            :before-upload="beforeUpload"
                                            action="/import">
                                        <img v-if="goodsForm.condensePicLink" :src="goodsForm.condensePicLink" class="avatar">
                                        <i v-else class="el-icon-plus avatar-uploader-icon"></i>
                                    </el-upload>
                                </el-form-item>
                                <el-form-item label="商品品牌" prop="brandName">
                                    <el-input v-model="goodsForm.brandName"></el-input>
                                </el-form-item>
                                <el-form-item label="商品名称" prop="name">
                                    <el-input v-model="goodsForm.name"></el-input>
                                </el-form-item>
                                <el-form-item label="商品型号" prop="marque">
                                    <el-input v-model="goodsForm.marque"></el-input>
                                </el-form-item>
                                <el-form-item label="参考价格" prop="price">
                                    <el-input v-model="goodsForm.price"></el-input>
                                </el-form-item>
                                <el-row class="mt">
                                    <el-col :span="24" style="text-align: right;">
                                        <el-button type="primary" @click="saveGoods" v-if="this.goodsTitle=='新建商品'">保存</el-button>
                                        <el-button type="primary" @click="modifyGoods" v-if="this.goodsTitle=='修改商品'">修改</el-button>
                                        <el-button @click="resetForm('goodsForm')">重置</el-button>
                                    </el-col>
                                </el-row>
                            </el-form>
                        </el-card>
                    </el-col>
                    <el-col :span="17">
                        <el-card shadow="always">
                            <div slot="header">

                                <span>商品列表</span>
                                <div style="float: right;">
                                    <el-cascader expand-trigger="hover" :options="options"  placeholder="请选择类型" :clearable="true"
                                                 :change-on-select="true" :show-all-levels="false" @change="goodsSearchHandleChange">
                                    </el-cascader>
                                    <el-input v-model="goodsSearchName" placeholder="请输入商品名" style="width: 180px"></el-input>
                                    <el-button type="primary" @click="searchGoods">搜索</el-button>
                                </div>
                            </div>
                            <el-row>
                                <el-col :span="24">
                                    <el-table :data="goodsTableData" border height="450" size="mini">
                                        <el-table-column prop="name" label="商品名称" >
                                        </el-table-column>
                                        <el-table-column prop="typeName" label="类型" >
                                        </el-table-column>
                                        <el-table-column prop="brandName" label="品牌名" >
                                        </el-table-column>
                                        <el-table-column prop="marque" label="型号" >
                                        </el-table-column>
                                        <el-table-column prop="price" label="参考价" >
                                        </el-table-column>
                                        <el-table-column prop="status" label="状态" >
                                            <template slot-scope="scope">
                                                <el-tag type="danger" v-if="scope.row.status=='disabled'">冻结</el-tag>
                                                <el-tag v-if="scope.row.status=='enabled'">正常</el-tag>
                                                <el-tag type="success" v-if="scope.row.status=='unaudited'">待审核</el-tag>
                                            </template>
                                        </el-table-column>
                                        <el-table-column fixed="right" label="操作" width="250">
                                            <template slot-scope="scope">
                                                <el-button-group>
                                                    <el-button size="mini" @click="openGoodsModify(scope.row)">修改</el-button>
                                                    <el-button type="primary" size="mini" v-if="scope.row.status=='unaudited'" @click="modifyGoodsStatus(scope.row.id,'enabled')">发布</el-button>
                                                    <el-button type="danger" size="mini" v-if="scope.row.status=='enabled'" @click="modifyGoodsStatus(scope.row.id,'disabled')">冻结</el-button>
                                                    <el-button type="primary" size="mini" v-if="scope.row.status=='disabled'" @click="modifyGoodsStatus(scope.row.id,'enabled')">解冻原型</el-button>
                                                    <el-button type="primary" size="mini" v-if="scope.row.status=='disabled'" @click="modifyGoodsStatus(scope.row.id,'enabledAll')">解冻全部</el-button>
                                                </el-button-group>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                    <el-pagination
                                            :page-sizes="[8, 16, 32, 64]"
                                            :current-page="goodsCurrent"
                                            :page-size ="goodsSize"
                                            @size-change="goodsHandleSizeChange"
                                            @current-change="goodsHandleCurrentChange"
                                            layout="total, sizes, prev, pager, next, jumper"
                                            :total="goodsTotal">
                                    </el-pagination>
                                </el-col>
                            </el-row>
                        </el-card>
                    </el-col>
                </el-row>
                <!----------------超市管理-------------------->
                <el-row v-if="this.activeIndex=='3'">
                    <el-col>
                        <el-card>
                            <span>超市列表</span>
                            <div style="float: right;">
                                <el-input v-model="shopName" placeholder="请输入" maxlength="10" show-word-limit style="width: 180px"></el-input>
                                <el-button type="primary" @click="initShopTable">搜索</el-button>
                            </div>
                            <el-table :data="shopTableData" border height="450" size="mini" @expand-change="expandSelect" :row-key='getRowKeys' :expand-row-keys="expands">
                                <el-table-column type="expand">
                                    <el-card>
                                        <template slot-scope="props">
                                            <el-table :data="shopGoodsTableData" border max-height="400" size="mini">
                                                <el-table-column prop="name" label="商品名" >
                                                </el-table-column>
                                                <el-table-column prop="typeName" label="类型" >
                                                </el-table-column>
                                                <el-table-column prop="brandName" label="品牌" >
                                                </el-table-column>
                                                <el-table-column prop="marque" label="型号" >
                                                </el-table-column>
                                                <el-table-column prop="depict" label="描述" >
                                                </el-table-column>
                                                <el-table-column prop="createTime" label="创建时间">
                                                </el-table-column>
                                                <el-table-column label="状态">
                                                    <template slot-scope="scope" >
                                                        <el-tag v-if="scope.row.status == 'online'">上架中</el-tag>
                                                        <el-tag type="info" v-if="scope.row.status == 'offline'">已下架</el-tag>
                                                        <el-tag type="danger" v-if="scope.row.status == 'soldOut'">售罄</el-tag>
                                                        <el-tag type="success" v-if="scope.row.status == 'prepared'">准备中</el-tag>
                                                        <el-tag type="danger" v-if="scope.row.status == 'disabled'">冻结</el-tag>
                                                    </template>
                                                </el-table-column>
                                                <el-table-column label="价格" width="175">
                                                    <template slot-scope="scope" >
                                                        <label>原价：{{scope.row.price}}元</label>
                                                        <label>现价：{{scope.row.currentPrice}}元</label>
                                                    </template>
                                                </el-table-column>
                                                <el-table-column prop="number" label="数量" width="60">
                                                </el-table-column>
                                                <el-table-column label="操作" width="200">
                                                    <template slot-scope="scope">
                                                        <el-button-group>
                                                            <el-button  @click="openDisabled(scope.row.goodsId,'disabled')" v-if="scope.row.status == 'prepared' || scope.row.status == 'online'" size="mini" type="danger">冻结</el-button>
                                                            <el-button  @click="openEnabled(scope.row.goodsId,'prepared')" v-if="scope.row.status == 'disabled'" size="mini" type="primary">解冻</el-button>
                                                            <el-button  @click="openPic(scope.row.goodsId)" size="mini">图片</el-button>
                                                        </el-button-group>
                                                    </template>
                                                </el-table-column>
                                            </el-table>
                                            <el-pagination
                                                    :page-sizes="[6, 12, 24, 48]"
                                                    :current-page="shopGoodsCurrent"
                                                    :page-size.sync ="shopGoodsSize"
                                                    @size-change="handleShopGoodsSizeChange"
                                                    @current-change="handleShopGoodsCurrentChange"
                                                    layout="total, sizes, prev, pager, next, jumper"
                                                    :total="shopGoodsTotal">
                                            </el-pagination>
                                        </template>
                                    </el-card>
                                </el-table-column>
                                <el-table-column prop="name" label="超市名称" >
                                </el-table-column>
                                <el-table-column prop="remark" label="介绍" >
                                </el-table-column>
                                <el-table-column label="状态">
                                    <template slot-scope="scope" >
                                        <el-tag v-if="scope.row.status == 'enabled'">正常</el-tag>
                                        <el-tag type="danger" v-if="scope.row.status == 'disabled'">冻结</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="address" label="地址" >
                                </el-table-column>
                                <el-table-column prop="goodsNumber" label="商品种类" >
                                </el-table-column>
                                <el-table-column prop="dealNumber" label="交易量" >
                                </el-table-column>
                                <el-table-column fixed="right" label="操作" width="200">
                                    <template slot-scope="scope">
                                        <el-button-group>
                                            <el-button type="danger" size="mini" v-if="scope.row.status=='enabled'" @click="modifyShopStatus(scope.row.id,'disabled')">冻结</el-button>
                                            <el-button type="primary" size="mini" v-if="scope.row.status=='disabled'" @click="modifyShopStatus(scope.row.id,'enabled')">解冻超市</el-button>
                                            <el-button type="primary" size="mini" v-if="scope.row.status=='disabled'" @click="modifyShopStatus(scope.row.id,'enabledAll')">解冻全部</el-button>
                                        </el-button-group>
                                    </template>
                                </el-table-column>
                            </el-table>
                            <el-pagination
                                    :page-sizes="[6, 12, 18, 24]"
                                    :current-page="shopCurrent"
                                    :page-size ="shopSize"
                                    @size-change="handleShopSizeChange"
                                    @current-change="handleShopCurrentChange"
                                    layout="total, sizes, prev, pager, next, jumper"
                                    :total="shopTotal">
                            </el-pagination>
                        </el-card>
                    </el-col>
                </el-row>
                <!----------------订单管理-------------------->
                <el-row v-if="this.activeIndex=='4'">
                    <el-col>
                        <el-row>
                            <el-card>
                                <span>订单列表</span>
                                <el-tabs @tab-click="handleTabClick" v-model="activeDealName">
                                    <el-tab-pane :label="tabPane.all" name="all"></el-tab-pane>
                                    <el-tab-pane :label="tabPane.waitPay" name="waitPay"></el-tab-pane>
                                    <el-tab-pane :label="tabPane.waitSend" name="waitSend"></el-tab-pane>
                                    <el-tab-pane :label="tabPane.waitConfirm" name="waitConfirm"></el-tab-pane>
                                    <el-tab-pane :label="tabPane.waitComment" name="waitComment"></el-tab-pane>
                                    <el-tab-pane :label="tabPane.waitRefund" name="waitRefund"></el-tab-pane>
                                    <el-tab-pane :label="tabPane.refund" name="refund"></el-tab-pane>
                                    <el-tab-pane :label="tabPane.over" name="over"></el-tab-pane>
                                </el-tabs>
                                <el-card style="width: 100%;height: 50px">
                                    <el-row>
                                        <el-col :span="10"><label>宝贝</label></el-col>
                                        <el-col :span="3"><label>单价</label></el-col>
                                        <el-col :span="4"><label>数量</label></el-col>
                                        <el-col :span="7"><label>操作</label></el-col>
                                    </el-row>
                                </el-card>
                                <div v-for="t in dealTableData" style="width: 100%">
                                    <el-card>
                                        <el-row style="height: 25px">
                                            <el-col :span="5"><span>创建时间:{{t.createTime}}</span></el-col>
                                            <el-col :span="7"><span>交易单号:{{t.dealId}}</span></el-col>
                                            <el-col :span="4"><span>超市名:{{t.shopName}}</span></el-col>
                                            <el-col :span="3"><span>用户名:{{t.userName}}</span></el-col>
                                            <el-col :span="2">
                                                <el-tag v-if="t.status == 'waitPay'">待付款</el-tag>
                                                <el-tag v-if="t.status == 'waitSend'">待发货</el-tag>
                                                <el-tag v-if="t.status == 'waitConfirm'">待收货</el-tag>
                                                <el-tag v-if="t.status == 'waitComment'">待评价</el-tag>
                                                <el-tag v-if="t.status == 'waitRefund'">待退款</el-tag>
                                                <el-tag v-if="t.status == 'refund'">已退款</el-tag>
                                                <el-tag v-if="t.status == 'over'">完成</el-tag>
                                            </el-col>
                                            <el-col :span="3">
                                                <el-button-group>
                                                    <el-button size="mini" v-if="t.status == 'waitRefund'" type="warning" @click="openRefund(t.dealId,t.userId,t.shopId)">强制退款</el-button>
                                                </el-button-group>
                                            </el-col>
                                        </el-row>
                                    </el-card>
                                    <el-card v-for="v in t.cardData" style="height: 55px">
                                        <el-row>
                                            <el-col :span="10"><span>{{v.goodsName}}</span></el-col>
                                            <el-col :span="4"><span>￥{{v.goodsPrice}}元</span></el-col>
                                            <el-col :span="3"><span>{{v.goodsNumber}}</span></el-col>
                                            <el-col :span="6"></el-col>
                                        </el-row>
                                    </el-card><br>
                                </div>
                                <el-pagination
                                        :page-sizes="[3, 6, 9, 15]"
                                        :current-page="dealCurrent"
                                        :page-size="dealSize"
                                        :total="dealTotal"
                                        @size-change="handleDealSizeChange"
                                        @current-change="handleDealCurrentChange"
                                        layout="total, sizes, prev, pager, next, jumper">
                                </el-pagination>
                            </el-card>
                        </el-row>
                    </el-col>
                </el-row>
            </el-main>
        </el-container>
    </el-container>

    <el-dialog title="商品图片展示" :visible.sync="picDgVisible" width="650px">
        <div>
            <ul style="display: flex;flex-wrap: wrap;">
                <li v-for="v in picData" style="padding: 5px;list-style: none;margin-right: 15px;border: 1px solid #eee;">
                    <img :src="v.url" style="height: 150px;width: 150px">
                </li>
            </ul>

        </div>
    </el-dialog>

    <el-dialog title="信息展示" :visible.sync="messageDgVisible" width="650px" height="650px">
        <div v-for="v in messageData">
            <p>
                <el-tag v-if="v.status=='new'" type="success">新</el-tag>
                {{v.message}}
                <el-button size="mini" type="danger" icon="el-icon-delete" @click="openDeleteMessage(v.id)" style="float: right"></el-button>
            </p>
        </div>
    </el-dialog>
</div>

</body>
<script src="js/vue.js"></script>
<script src="js/index.js"></script>
<script src="js/axios.min.js"></script>
<script src="js/vuescroll-native.js"></script>
<script src="js/vuescroll-slide.js"></script>
<script src="js/vuescroll.js"></script>
<script src="js/jquery-3.2.1.min.js"></script>
<script type="text/javascript">
    new Vue({
        el:"#manage",
        data:function(){
            return {
                activeIndex:"1",
                newMessageNumber:0,
                messageDgVisible:false,
                messageData:[],
                //商品类型所用参数

                activeDealName:"all",
                tabPane:{
                    all:"全部",
                    waitPay:"待付款",
                    waitSend:"待发货",
                    waitConfirm:"待收货",
                    waitComment:"待评价",
                    waitRefund:"待退款",
                    refund:"已退款",
                    over:"完成",
                },

                tableData: [],
                title:"新建类型",
                total:0,
                current:1,
                size:8,
                options: [],
                form: {
                    id:null,
                    pId:null,
                    name: null,
                    parentName:null,
                    value:null,
                    summary:null,
                    pName:[],
                    level:null,

                },
                formStyle:"display:none;",
                labelStyle:"color:#2c8cf0;display:block;",
                inputStyle:"display:none",
                divStyle:"display:none",
                //商品所用参数
                goodsSearchName:null,
                searchTypeId:null,
                goodsTableData:[],
                goodsCurrent:1,
                goodsSize:8,
                goodsTotal:0,
                goodsForm: {
                    id:null,
                    typeId:null,
                    name: null,
                    pName:[],
                    price:null,
                    brandName:null,
                    marque:null,
                    condensePicLink:null,
                },
                goodsFormStyle:"display:none;",
                goodsTitle:"新建商品",

                //超市所用参数
                shopTableData:[],
                shopCurrent:1,
                shopTotal:0,
                shopSize:6,
                shopName:null,

                expands: [],
                getRowKeys (row) {
                    return row.id
                },

                //超市商品所用参数
                shopId:null,
                shopGoodsTableData:[],
                shopGoodsCurrent:1,
                shopGoodsSize:6,
                shopGoodsTotal:0,

                //订单所用参数
                dealTableData:[],
                dealSize:3,
                dealCurrent:1,
                dealStatus:null,
                dealTotal:0,

                picDgVisible:false,
                picData:{},
            }
        },
        methods:{
            getParentGoodsType:function(){
                const _this=this;
                axios.get('http://'+window.location.host+'/goodsType/getParentGoodsType')
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.options=response.data.rtnData;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "获取上级类型数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            getNewMessageNumber:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/getNewMessageNumber',{latterId:"admin"})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.newMessageNumber=response.data.rtnData;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            openMessage:function(){
                this.messageDgVisible=true;
                this.getMessage();
            },
            getMessage:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/getMessage',{latterId:"admin",type:"admin"})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.messageData=response.data.rtnData;
                            _this.getNewMessageNumber();
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            openDeleteMessage:function(id){
                this.$confirm('删除该信息, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.deleteMessage(id);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消删除'
                    });
                });
            },
            deleteMessage:function(id){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/deleteMessage',{id:id})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.getMessage();
                            _this.$message({
                                type: 'success',
                                message: '删除成功!'
                            });
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            //左侧栏目功能
            handleSelect(key) {
                this.activeIndex=key;
                if(this.activeIndex=="1")   this.initTable();
                else if(this.activeIndex=="2")   this.initGoodsTable();
                else if(this.activeIndex=="3")   this.initShopTable();
                else if(this.activeIndex=="4")   this.initDealTable();

            },

            logout:function(){
                this.$confirm('退出登录, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    axios.get('http://'+window.location.host+'/logout')
                        .then(function (response) {
                            window.location.href = "";
                        })
                        .catch(function (error) {
                        });
                    this.$message({
                        type: 'success',
                        message: '退出成功!'
                    });
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },
            //商品类型
            initTable:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/goodsType/getGoodsType',{size:_this.size,current:_this.current})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.tableData=response.data.rtnData;
                            _this.total=response.data.total;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "初始化类型数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            saveParameter:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/goodsType/addGoodsType',_this.form)
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.form.id=response.data.rtnData.id;
                            _this.initTable();
                            _this.title="修改类型";
                            _this.$message('新建类型数据成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "新建类型数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            modifyParameter:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/goodsType/modifyGoodsType',_this.form)
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initTable();
                            _this.$message('修改类型数据成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "修改类型数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            resetForm:function(formName){
                const _this=this;
                _this.$refs[formName].resetFields();
                if(formName=="form") {
                    _this.title="新建类型";
                    _this.id=null;
                }
                else if(formName=="goodsForm") _this.goodsTitle="新建商品";
            },
            openModify:function(goodsType){
                const _this=this;
                _this.form=JSON.parse(JSON.stringify(goodsType));
                _this.formStyle="display:block;"
                _this.title="修改类型";
            },
            //级联选择器
            handleChange:function(value){
                this.form.pId=value[value.length-1];
            },
            handleSizeChange:function(val) {
                this.size=val;
                this.initTable();
            },
            handleCurrentChange:function(val) {
                this.current=val;
                this.initTable();
            },

            btnCk:function(event){
                this.formStyle="display:block;"
            },

            //商品

            goodsSearchHandleChange:function(value){
                this.searchTypeId=value[value.length-1];
            },

            initGoodsTable:function(){
                const _this=this;
                _this.loading=true;
                axios.post('http://'+window.location.host+'/goods/getGoodsPage',{size:_this.goodsSize,
                    current:_this.goodsCurrent,typeId:_this.searchTypeId,name:_this.goodsSearchName,status:"all",number:0})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.goodsTableData=response.data.rtnData;
                            _this.goodsTotal=response.data.total;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "初始化商品数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            searchGoods:function(){
                this.initGoodsTable();
            },
            saveGoods:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/goods/addGoods',{form:_this.goodsForm,status:"enabled"})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.goodsForm.id=response.data.rtnData.id;
                            _this.initGoodsTable();
                            _this.title="修改商品";
                            _this.$message('新建商品数据成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "新建商品数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            modifyGoods:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/goods/modifyGoods',_this.goodsForm)
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initGoodsTable();
                            _this.$message('修改商品数据成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "修改商品数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            modifyGoodsStatus:function(id,status){
                const _this=this;
                axios.post('http://'+window.location.host+'/goods/modifyGoodsStatus',{id:id,status:status})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initGoodsTable();
                            _this.$message('修改商品状态成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "修改商品状态"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            openGoodsModify:function(goods){
                const _this=this;
                _this.goodsForm=JSON.parse(JSON.stringify(goods));
                _this.goodsFormStyle="display:block;"
                _this.goodsTitle="修改商品";
            },
            goodsBtnCk:function(event){
                this.goodsFormStyle="display:block;"
            },
            goodsHandleChange:function(value){
                this.goodsForm.typeId=value[value.length-1];
            },
            goodsHandleSizeChange:function (val) {
                this.goodsSize=val;
                this.initGoodsTable();
            },
            goodsHandleCurrentChange:function(val){
                this.goodsCurrent=val;
                this.initGoodsTable();
            },
            onGoodsSuccess:function(response, file, fileList) {
                this.goodsForm.condensePicLink=response.rtnData;
            },
            onError(err, file, fileList) {},
            beforeUpload(file) {},
            //超市管理
            initShopTable:function () {
                const _this=this;
                axios.post('http://'+window.location.host+'/shop/getShopPage',{size:_this.shopSize,current:_this.shopCurrent,shopName:_this.shopName})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.shopTableData=response.data.rtnData;
                            _this.shopTotal=response.data.total;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "初始化类型数据"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },
            handleShopSizeChange:function(val) {
                this.shopSize=val;
                this.initShopTable();
            },
            handleShopCurrentChange:function(val) {
                this.shopCurrent=val;
                this.initShopTable();
            },

            expandSelect:function (row, expandedRows) {
                const _this = this;
                _this.shopId=row.id;
                if (expandedRows.length) {
                    _this.expands = [];
                    if (row) {
                        _this.expands.push(row.id);
                    }
                    _this.initShopGoodsTable();
                } else {
                    _this.shopGoodsTableData=[];
                    _this.expands = [];
                }
            },

            handleShopGoodsSizeChange:function(val){
                this.shopGoodsSize=val;
                this.initShopGoodsTable();
            },
            handleShopGoodsCurrentChange:function(val){
                this.shopGoodsCurrent=val;
                this.initShopGoodsTable();
            },


            openDisabled:function(id,status){
                this.$prompt('请输入冻结理由', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                }).then(({ value }) => {
                    this.modifyShopGoodsStatus(id,status);
                    this.addMessage(value,id,"disabledShopGoods",this.shopId);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },
            openEnabled:function(id,status){
                this.$confirm('解冻该商品, 是否继续?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.modifyShopGoodsStatus(id,status);
                    this.addMessage("该商品已解冻！",id,"enabledShopGoods",this.shopId);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },
            addMessage:function(message,relatedId,type,latterId){
                const _this=this;
                axios.post('http://'+window.location.host+'/message/addMessage',{formerId:"admin",latterId:latterId
                    ,relatedId:relatedId,context:message,type:type})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            modifyShopGoodsStatus:function(id,status){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/modifyShopGoodsStatus',{goodsId:id,status:status,shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initShopGoodsTable();
                            _this.$message('修改超市商品状态成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "修改超市商品状态"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            modifyShopStatus:function(id,status){
                const _this=this;
                axios.post('http://'+window.location.host+'/shop/modifyShopStatus',{id:id,status:status})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initShopTable();
                            _this.initShopGoodsTable();
                            _this.$message('修改超市状态成功！');
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "修改超市状态"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            openRefund:function(dealId,userId,shopId){
                this.$confirm('确认将订单强制退款?', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(() => {
                    this.refund(dealId,userId,shopId);
                }).catch(() => {
                    this.$message({
                        type: 'info',
                        message: '已取消'
                    });
                });
            },
            refund:function(dealId,userId,shopId){
                const _this=this;
                axios.post('http://'+window.location.host+'/deal/shopRefundDeal',{dealId:dealId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.initDealTable();
                            _this.addMessage("该商品已强制退款",dealId,"adminRefund",userId);
                            _this.addMessage("该商品已强制退款",dealId,"adminRefund",shopId);
                            _this.$message({
                                message: '退款成功',
                                type: 'success'
                            });
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: '退款'+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            openPic:function(goodsId){
                this.picDgVisible=true;
                this.picGoodsId=goodsId;
                this.getShopGoodsPic(this.picGoodsId);
            },
            getShopGoodsPic:function(goodsId){
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/getShopGoodsPic',{goodsId:goodsId,shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.picData=response.data.rtnData;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{}
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            initShopGoodsTable:function () {
                const _this=this;
                axios.post('http://'+window.location.host+'/shopGoods/getShopGoodsPage',{form:{current:_this.shopGoodsCurrent,size:_this.shopGoodsSize},shopId:_this.shopId})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.shopGoodsTableData=response.data.rtnData.dataList;
                            _this.shopGoodsTotal=response.data.total;
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: "获取超市商品信息"+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

            handleTabClick:function (obj) {
                if(obj.name=="all"){
                    this.dealStatus=null;
                    this.initDealTable();
                } else{
                    this.dealStatus=obj.name;
                    this.initDealTable();
                }
                this.dealCurrent=1;
            },
            handleDealSizeChange:function(val){
                this.dealSize=val;
                this.initDealTable();
            },
            handleDealCurrentChange:function(val){
                this.dealCurrent=val;
                this.initDealTable();
            },

            initDealTable:function(){
                const _this=this;
                axios.post('http://'+window.location.host+'/deal/getDealPage',{size:_this.dealSize,current:_this.dealCurrent,status:_this.dealStatus})
                    .then(function (response) {
                        if(response.data.rtnFlag=="9999"){//请求成功
                            _this.dealTableData=response.data.rtnData.resultList;
                            _this.dealTotal=response.data.total;
                            _this.tabPane.all="全部("+response.data.rtnData.dataStatistics.all+")";
                            _this.tabPane.waitPay="待付款("+response.data.rtnData.dataStatistics.waitPay+")";
                            _this.tabPane.waitSend="待发货("+response.data.rtnData.dataStatistics.waitSend+")";
                            _this.tabPane.waitConfirm="待收货("+response.data.rtnData.dataStatistics.waitConfirm+")";
                            _this.tabPane.waitComment="待评价("+response.data.rtnData.dataStatistics.waitComment+")";
                            _this.tabPane.waitRefund="待退款("+response.data.rtnData.dataStatistics.waitRefund+")";
                            _this.tabPane.refund="已退款("+response.data.rtnData.dataStatistics.refund+")";
                            _this.tabPane.over="完成("+response.data.rtnData.dataStatistics.over+")";
                        }else if(response.data.rtnFlag=="1001"){//未登录
                            //_this.loginDgVisible=true;
                        }else{
                            _this.$bdmsg({
                                type:"toast",
                                msgType:"error",
                                message: '初始化交易列表数据'+'失败！'+response.data.rtnMsg
                            });
                        }
                    }).catch(function (error) {
                    // handle error
                    console.log(error);
                }).then(function () {
                    // always executed
                });
            },

        },
        mounted: function() {
            const _this = this;
            _this.getParentGoodsType();
            _this.getNewMessageNumber();
            _this.initTable();
        },
    });
</script>
</html>